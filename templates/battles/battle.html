{% extends 'base.html' %}
{% load static %}

{% block title %}Battle - {{ game_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/battle.css' %}">
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="battle-screen">
        <!-- Enemy Area -->
        <div class="enemy-area">
            {% for participant in battle_state.participants %}
                {% if participant.type == 'enemy' and participant.is_active %}
                <div class="enemy-display" data-participant-id="{{ participant.id }}">
                    <div class="character-name">{{ participant.name }} Lv.{{ participant.level }}</div>
                    <div class="stat-bars">
                        <div class="hp-bar stat-bar">
                            <div class="stat-bar-fill" style="width: {% widthratio participant.current_hp participant.max_hp 100 %}%"></div>
                            <span class="stat-bar-text">{{ participant.current_hp }}/{{ participant.max_hp }} HP</span>
                        </div>
                    </div>
                    <div class="character-sprite enemy" style="background-color: #ff6b6b;">
                        <!-- Enemy sprite placeholder -->
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Player Area -->
        <div class="player-area">
            {% for participant in battle_state.participants %}
                {% if participant.type == 'player' %}
                <div class="player-display">
                    <div class="character-name">{{ participant.name }} Lv.{{ participant.level }}</div>
                    <div class="stat-bars">
                        <div class="hp-bar stat-bar">
                            <div class="stat-bar-fill" style="width: {% widthratio participant.current_hp participant.max_hp 100 %}%"></div>
                            <span class="stat-bar-text">{{ participant.current_hp }}/{{ participant.max_hp }} HP</span>
                        </div>
                        <div class="mp-bar stat-bar mt-1">
                            <div class="stat-bar-fill" style="width: {% widthratio participant.current_mp participant.max_mp 100 %}%"></div>
                            <span class="stat-bar-text">{{ participant.current_mp }}/{{ participant.max_mp }} MP</span>
                        </div>
                    </div>
                    <div class="character-sprite player" style="background-color: #51cf66;">
                        <!-- Player sprite placeholder -->
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <!-- Battle Controls -->
    <div class="battle-controls mt-4">
        <div class="row">
            <div class="col-md-6">
                <h5>Battle Actions</h5>
                <div class="action-buttons">
                    <button class="btn skill-btn" onclick="performBasicAttack()">Basic Attack</button>
                    <button class="btn skill-btn" onclick="showCodeEditor()">Cast Spell (Code)</button>
                    <button class="btn skill-btn" disabled>Items</button>
                    <button class="btn skill-btn" disabled>Run</button>
                </div>
            </div>
            <div class="col-md-6">
                <h5>Battle Log</h5>
                <div class="battle-log" id="battleLog">
                    <div class="battle-log-entry info">Battle Start!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Code Editor Modal -->
    <div class="code-editor-modal" id="codeEditorModal" style="display: none;">
        <div class="code-editor">
            <h5>Write Your Spell Code</h5>
            <p>Use Python to cast a spell! Available variables: <code>enemy</code>, <code>player</code></p>
            <textarea id="spellCode" placeholder="# Calculate damage based on player stats&#10;damage = player.attack * 2&#10;&#10;# Use a loop for multi-hit&#10;for i in range(3):&#10;    print(f'Hit {i+1}: {damage} damage!')&#10;&#10;# Return total damage&#10;result = damage * 3"></textarea>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="executeSpellCode()">Cast Spell</button>
                <button class="btn btn-secondary" onclick="hideCodeEditor()">Cancel</button>
            </div>
            <div id="codeOutput" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
const battleState = {{ battle_state|safe }};
let codeEditorVisible = false;

function showCodeEditor() {
    document.getElementById('codeEditorModal').style.display = 'block';
    codeEditorVisible = true;
}

function hideCodeEditor() {
    document.getElementById('codeEditorModal').style.display = 'none';
    codeEditorVisible = false;
    document.getElementById('codeOutput').innerHTML = '';
}

function addBattleLogEntry(message, type = 'info') {
    const log = document.getElementById('battleLog');
    const entry = document.createElement('div');
    entry.className = `battle-log-entry ${type}`;
    entry.textContent = message;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function updateBattleDisplay(newState) {
    // Update HP bars and other visual elements
    newState.participants.forEach(participant => {
        const hpBar = document.querySelector(`[data-participant-id="${participant.id}"] .hp-bar .stat-bar-fill`);
        if (hpBar) {
            const hpPercent = (participant.current_hp / participant.max_hp) * 100;
            hpBar.style.width = `${hpPercent}%`;
            
            const hpText = document.querySelector(`[data-participant-id="${participant.id}"] .hp-bar .stat-bar-text`);
            if (hpText) {
                hpText.textContent = `${participant.current_hp}/${participant.max_hp} HP`;
            }
        }
    });
}

async function performBasicAttack() {
    // Find first active enemy
    const enemy = battleState.participants.find(p => p.type === 'enemy' && p.is_active);
    if (!enemy) return;
    
    try {
        const response = await fetch('/battles/action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action_type: 'attack',
                target_id: enemy.id
            })
        });
        
        const data = await response.json();
        if (data.success) {
            addBattleLogEntry('You performed a basic attack!', 'damage');
            updateBattleDisplay(data.battle_state);
            
            if (data.battle_ended) {
                if (data.victory) {
                    addBattleLogEntry('Victory! You defeated all enemies!', 'info');
                    setTimeout(() => {
                        alert('Victory! You gained experience and gold!');
                        window.location.href = '/';
                    }, 2000);
                } else {
                    addBattleLogEntry('Defeat... Try again!', 'damage');
                }
            }
        }
    } catch (error) {
        console.error('Battle action error:', error);
        addBattleLogEntry('Error performing action!', 'damage');
    }
}

async function executeSpellCode() {
    const code = document.getElementById('spellCode').value;
    if (!code.trim()) {
        alert('Please write some spell code!');
        return;
    }
    
    try {
        const response = await fetch('/battles/action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action_type: 'code',
                code: code
            })
        });
        
        const data = await response.json();
        if (data.success) {
            addBattleLogEntry('Spell cast successfully!', 'info');
            hideCodeEditor();
            updateBattleDisplay(data.battle_state);
            
            if (data.battle_ended) {
                if (data.victory) {
                    addBattleLogEntry('Victory! You defeated all enemies!', 'info');
                    setTimeout(() => {
                        alert('Victory! You gained experience and gold!');
                        window.location.href = '/';
                    }, 2000);
                } else {
                    addBattleLogEntry('Defeat... Try again!', 'damage');
                }
            }
        } else {
            document.getElementById('codeOutput').innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
        }
    } catch (error) {
        console.error('Spell execution error:', error);
        document.getElementById('codeOutput').innerHTML = '<div class="alert alert-danger">Error executing spell!</div>';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (battleState.current_turn) {
        addBattleLogEntry(`${battleState.current_turn.character_name}'s turn!`, 'info');
    }
});
</script>
{% endblock %}